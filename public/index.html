<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Empires - Multiplayer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding: 20px 0;
        }

        /* Connection Screen Styles */
        .connection-screen {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
        }

        .connection-screen h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .connection-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .connection-form input {
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
        }

        .connection-form button {
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .connection-form button:hover {
            background-color: #2980b9;
        }

        .connection-form button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-message.info {
            background-color: #d4edda;
            color: #155724;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Nation Selection Styles */
        .nation-selection {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
        }
        
        .nation-selection h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .waiting-message {
            font-size: 18px;
            color: #7f8c8d;
            margin: 20px 0;
        }

        .player-info {
            background: #ecf0f1;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .nation-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            justify-items: center;
            max-width: 600px;
            margin: 20px auto;
        }
        
        .nation-card {
            border: 3px solid #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ecf0f1;
        }
        
        .nation-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .nation-card.selected {
            border-color: #e74c3c;
            background: #ffe5e5;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .nation-card.taken {
            border-color: #95a5a6;
            background: #bdc3c7;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .nation-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .nation-description {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .nation-special {
            font-size: 0.85em;
            color: #e74c3c;
            font-weight: bold;
            background: rgba(231,76,60,0.1);
            padding: 8px;
            border-radius: 5px;
        }
        
        /* Game Container Styles */
        .game-container {
            display: none;
            flex-direction: column;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            align-items: center;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(7, 70px);
            grid-template-rows: repeat(7, 70px);
            gap: 2px;
            margin: 10px auto;
            border: 2px solid #333;
            background-color: #8B4513;
            padding: 10px;
        }
        
        .cell {
            width: 70px;
            height: 70px;
            background-color: #DEB887;
            border: 1px solid #8B4513;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 10px;
            font-weight: bold;
        }
        
        .cell.middle-row {
            background-color: #B8860B;
        }
        
        .cell.highlighted {
            background-color: #90EE90;
        }
        
        .cell.selected {
            background-color: #FFD700;
        }
        
        .cell.drop-target {
            background-color: #87CEEB !important;
            border: 3px dashed #4169E1 !important;
        }
        
        .cell.drop-invalid {
            background-color: #FFB6C1 !important;
            border: 3px dashed #DC143C !important;
        }
        
        .piece {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: move;
        }

        .piece.dragging {
            opacity: 0.5;
            transform: scale(1.1);
            z-index: 1000;
        }
        
        .figurine {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 50%;
            border: 2px solid;
            position: relative;
        }
        
        .player1 .figurine {
            background: linear-gradient(145deg, #4A90E2, #357EC7);
            border-color: #2E5C8A;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        
        .player2 .figurine {
            background: linear-gradient(145deg, #E74C3C, #C0392B);
            border-color: #A93226;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.3);
        }

        .health-dots {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        
        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid #333;
        }
        
        .health-dot.healthy {
            background-color: #44ff44;
        }
        
        .health-dot.damaged {
            background-color: #333333;
        }

        .game-info {
            text-align: center;
            margin: 20px 0;
        }

        .phase-info {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .turn-info {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .piece-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
            min-height: 50px;
            padding: 10px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .piece-button {
            padding: 8px 12px;
            border: 2px solid #333;
            background-color: #f9f9f9;
            cursor: grab;
            border-radius: 5px;
            font-size: 12px;
            user-select: none;
            position: relative;
            transition: all 0.2s ease;
        }
        
        .piece-button:hover {
            background-color: #e9e9e9;
            transform: translateY(-2px);
        }

        .piece-button:active {
            cursor: grabbing;
        }
        
        .piece-button.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }
        
        .piece-button.disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }

        .piece-button.dragging {
            opacity: 0.5;
            transform: scale(1.1);
            z-index: 1000;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .end-turn-btn {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .end-turn-btn:hover {
            background-color: #45a049;
        }
        
        .end-turn-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .player-boxes {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 500px;
            margin: 20px 0;
        }

        .player-box {
            border: 3px solid #333;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 120px;
        }

        .player-box.player1 {
            background: linear-gradient(145deg, #E3F2FD, #BBDEFB);
            border-color: #2196F3;
        }
        
        .player-box.player2 {
            background: linear-gradient(145deg, #FFEBEE, #FFCDD2);
            border-color: #F44336;
        }
        
        .player-box.active {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); }
            to { box-shadow: 0 0 30px rgba(0, 0, 0, 0.9); }
        }

        .message-log {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            height: 100px;
            overflow-y: auto;
            padding: 10px;
            margin: 20px 0;
            font-size: 14px;
        }

        .message-entry {
            margin-bottom: 5px;
        }

        .message-entry.error {
            color: #d32f2f;
            font-weight: bold;
        }

        .message-entry.success {
            color: #388e3c;
            font-weight: bold;
        }

        .message-entry.victory {
            color: #7b1fa2;
            font-weight: bold;
            font-size: 16px;
        }

        .drag-instructions {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 14px;
            color: #2e7d32;
        }
    </style>
</head>
<body>
    <!-- Connection Screen -->
    <div class="connection-screen" id="connectionScreen">
        <h1>🏛️ Ancient Empires</h1>
        <p>Join a multiplayer game room</p>
        
        <div class="connection-form">
            <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="20">
            <input type="text" id="roomIdInput" placeholder="Enter room ID (e.g., room1)" maxlength="20">
            <button id="joinGameBtn" onclick="joinGame()">Join Game</button>
        </div>
        
        <div id="connectionStatus" class="status-message" style="display: none;"></div>
    </div>

    <!-- Nation Selection Screen -->
    <div class="nation-selection" id="nationSelection">
        <h1>Choose Your Nation</h1>
        <div id="gameRoomInfo" class="player-info">
            <p>Waiting for players...</p>
        </div>
        
        <div id="nationCards" class="nation-cards">
            <div class="nation-card" data-nation="english">
                <div class="nation-name">English</div>
                <div class="nation-description">Masters of the longbow</div>
                <div class="nation-special">• Archers +1 range<br>• Archers don't consume ammunition on kill shots</div>
            </div>
            
            <div class="nation-card" data-nation="mongols">
                <div class="nation-name">Mongols</div>
                <div class="nation-description">Swift mounted archers</div>
                <div class="nation-special">• 2 x Horse Archers and no foot archers<br>• HA get 2 arrows each but no charge bonus<br>• Only 1 standard cavalry unit</div>
            </div>
            
            <div class="nation-card" data-nation="macedonians">
                <div class="nation-name">Macedonians</div>
                <div class="nation-description">Alexander and Bucephalus</div>
                <div class="nation-special">• General has cavalry abilities</div>
            </div>
            
            <div class="nation-card" data-nation="spartans">
                <div class="nation-name">Spartans</div>
                <div class="nation-description">Elite Spartan Hoplites</div>
                <div class="nation-special">• Heavy Infantry can move diagonally<br>• Heavy Infantry attacks hit all adjacent enemies simultaneously<br>• No archer unit</div>
            </div>
        </div>
        
        <div id="selectionStatus" class="waiting-message">
            Select your nation to continue
        </div>
    </div>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">
        <h1>Ancient Empires</h1>
        
        <div class="game-info">
            <div id="phaseInfo" class="phase-info">Waiting for game to start...</div>
            <div id="turnInfo" class="turn-info"></div>
        </div>

        <div class="message-log" id="messageLog">
            <div class="message-entry">Welcome to Ancient Empires!</div>
        </div>

        <div id="dragInstructions" class="drag-instructions" style="display: none;">
            Drag pieces from the selection area below to the board to place them
        </div>

        <div id="pieceSelector" class="piece-selector"></div>
        
        <div class="board" id="board"></div>
        
        <div class="controls">
            <button id="endTurnBtn" class="end-turn-btn" onclick="endTurn()" disabled>End Turn</button>
        </div>

        <div class="player-boxes">
            <div id="player1Box" class="player-box player1">
                <div class="player-title">Player 1</div>
                <div id="player1Name" class="player-name">-</div>
                <div id="player1Nation" class="nation-name">-</div>
            </div>
            
            <div id="player2Box" class="player-box player2">
                <div class="player-title">Player 2</div>
                <div id="player2Name" class="player-name">-</div>
                <div id="player2Nation" class="nation-name">-</div>
            </div>
        </div>
    </div>

    <script>
        // Socket.io connection (simulated for demo)
        let socket = null;
        let myPlayerNumber = 1;
        let myPlayerName = 'Demo Player';
        let gameState = null;
        let selectedPieceType = null;
        let selectedCell = null;
        let draggedPieceType = null;

        // Piece type definitions
        const pieceTypes = {
            'General': { symbol: '👑' },
            'Cavalry': { symbol: '🐎' },
            'Horse Archer': { symbol: '🏹🐎' },
            'Heavy Infantry': { symbol: '🛡️' },
            'Light Infantry': { symbol: '⚔️' },
            'Archer': { symbol: '🏹' }
        };

        // Demo game state
        gameState = {
            currentPlayer: 1,
            gamePhase: 'placement',
            placementTurn: 1,
            piecesPlacedThisTurn: 0,
            hasMoved: false,
            hasAttacked: false,
            gameEnded: false,
            winner: null,
            board: Array(7).fill(null).map(() => Array(7).fill(null)),
            player1Nation: 'english',
            player2Nation: 'mongols',
            player1Pieces: { 'General': 1, 'Cavalry': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 1 },
            player2Pieces: { 'General': 1, 'Cavalry': 1, 'Horse Archer': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 0 },
            selectedPiece: null,
            selectedCell: null,
            selectedPieceType: null,
            playerNames: { 1: 'Player 1', 2: 'Player 2' },
            nations: {
                english: {
                    name: 'English',
                    pieces: { 'General': 1, 'Cavalry': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 1 },
                    abilities: { archerRangeBonus: 1, archerKillAmmoSave: true }
                },
                mongols: {
                    name: 'Mongols',
                    pieces: { 'General': 1, 'Cavalry': 1, 'Horse Archer': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 0 },
                    abilities: { horseArcherMobility: true, horseArcherAmmo: 2 }
                }
            }
        };

        // Initialize demo
        document.getElementById('connectionScreen').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'flex';
        updateGameDisplay();

        function joinGame() {
            // Demo implementation - in real game this connects to server
            console.log('Demo mode - no server connection');
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }

        function selectNation(nationKey) {
            console.log('Demo: Selected nation', nationKey);
        }

        function updateGameDisplay() {
            if (!gameState) return;

            updateGameBoard();
        }

        function updateGameBoard() {
            if (!gameState) return;

            // Update phase info
            const phaseInfo = document.getElementById('phaseInfo');
            const turnInfo = document.getElementById('turnInfo');
            
            if (gameState.gamePhase === 'placement') {
                phaseInfo.textContent = `Placement Phase - Turn ${gameState.placementTurn}/2`;
                turnInfo.textContent = `Current Player: ${gameState.playerNames[gameState.currentPlayer]}`;
            } else if (gameState.gamePhase === 'battle') {
                phaseInfo.textContent = 'Battle Phase';
                turnInfo.textContent = `Current Player: ${gameState.playerNames[gameState.currentPlayer]}`;
            }

            // Update player info
            document.getElementById('player1Name').textContent = gameState.playerNames[1] || 'Player 1';
            document.getElementById('player2Name').textContent = gameState.playerNames[2] || 'Player 2';
            document.getElementById('player1Nation').textContent = gameState.nations[gameState.player1Nation]?.name || '-';
            document.getElementById('player2Nation').textContent = gameState.nations[gameState.player2Nation]?.name || '-';

            // Update active player highlight
            document.getElementById('player1Box').classList.toggle('active', gameState.currentPlayer === 1);
            document.getElementById('player2Box').classList.toggle('active', gameState.currentPlayer === 2);

            // Show drag instructions and update piece selector for placement phase
            if (gameState.gamePhase === 'placement' && gameState.currentPlayer === myPlayerNumber) {
                document.getElementById('dragInstructions').style.display = 'block';
                updatePieceSelector();
            } else {
                document.getElementById('dragInstructions').style.display = 'none';
                document.getElementById('pieceSelector').innerHTML = '';
            }

            // Update board
            renderBoard();

            // Update end turn button
            const endTurnBtn = document.getElementById('endTurnBtn');
            endTurnBtn.disabled = gameState.currentPlayer !== myPlayerNumber;
        }

        function updatePieceSelector() {
            if (!gameState || gameState.gamePhase !== 'placement') return;

            const selector = document.getElementById('pieceSelector');
            selector.innerHTML = '';

            const pieces = myPlayerNumber === 1 ? gameState.player1Pieces : gameState.player2Pieces;
            
            Object.entries(pieces).forEach(([type, count]) => {
                if (count > 0) {
                    const button = document.createElement('div');
                    button.className = 'piece-button';
                    button.draggable = true;
                    button.dataset.pieceType = type;
                    
                    button.innerHTML = `
                        <div>${pieceTypes[type].symbol}</div>
                        <div>${type} (${count})</div>
                    `;
                    
                    // Add drag event listeners
                    button.addEventListener('dragstart', handleDragStart);
                    button.addEventListener('dragend', handleDragEnd);
                    
                    selector.appendChild(button);
                }
            });
        }

        function handleDragStart(e) {
            draggedPieceType = e.currentTarget.dataset.pieceType;
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedPieceType);
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            draggedPieceType = null;
            
            // Clear all drop targets
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('drop-target', 'drop-invalid');
            });
        }

        function renderBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';

            for (let row = 0; row < 7; row++) {
                for (let col = 0; col < 7; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    
                    if (row === 3) cell.classList.add('middle-row');
                    
                    const piece = gameState.board[row][col];
                    if (piece) {
                        const pieceElement = createPieceElement(piece);
                        cell.appendChild(pieceElement);
                    }
                    
                    // Add drag and drop event listeners for placement phase
                    if (gameState.gamePhase === 'placement' && gameState.currentPlayer === myPlayerNumber) {
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        cell.addEventListener('drop', handleDrop);
                    } else {
                        // Add click handler for battle phase
                        cell.addEventListener('click', () => cellClick(row, col));
                    }
                    
                    boardElement.appendChild(cell);
                }
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);
            
            if (canPlacePiece(row, col)) {
                e.currentTarget.classList.add('drop-target');
            } else {
                e.currentTarget.classList.add('drop-invalid');
            }
        }

        function handleDragLeave(e) {
            // Only remove classes if we're actually leaving the cell (not entering a child element)
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('drop-target', 'drop-invalid');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-target', 'drop-invalid');
            
            const row = parseInt(e.currentTarget.dataset.row);
            const col = parseInt(e.currentTarget.dataset.col);
            const pieceType = e.dataTransfer.getData('text/plain');
            
            if (canPlacePiece(row, col) && pieceType) {
                placePiece(row, col, pieceType);
            }
        }

        function canPlacePiece(row, col) {
            if (!gameState || gameState.gamePhase !== 'placement') return false;
            if (gameState.currentPlayer !== myPlayerNumber) return false;
            if (gameState.board[row][col]) return false; // Cell occupied
            
            const requiredPieces = gameState.placementTurn === 1 ? 4 : 
                (Object.values(myPlayerNumber === 1 ? gameState.player1Pieces : gameState.player2Pieces).reduce((a,b) => a+b, 0));
            
            if (gameState.piecesPlacedThisTurn >= requiredPieces) return false;
            
            // Check placement zone (top 3 rows for player 1, bottom 3 rows for player 2)
            const validRows = myPlayerNumber === 1 ? [0, 1, 2] : [4, 5, 6];
            return validRows.includes(row);
        }

        function placePiece(row, col, pieceType) {
            const pieces = myPlayerNumber === 1 ? gameState.player1Pieces : gameState.player2Pieces;
            
            if (pieces[pieceType] === 0) {
                addMessage('No more pieces of this type available!', 'error');
                return;
            }

            // Create piece with basic properties
            const pieceData = {
                type: pieceType,
                player: myPlayerNumber,
                health: 3, // Simplified for demo
                maxHealth: 3,
                hasBeenReplenished: false,
                placedInTurn: gameState.placementTurn,
                nation: myPlayerNumber === 1 ? gameState.player1Nation : gameState.player2Nation
            };

            gameState.board[row][col] = pieceData;
            pieces[pieceType]--;
            gameState.piecesPlacedThisTurn++;

            addMessage(`Placed ${pieceType} at position ${row},${col}`, 'success');
            updateGameDisplay();
        }

        function createPieceElement(piece) {
            const pieceDiv = document.createElement('div');
            pieceDiv.className = `piece player${piece.player}`;
            
            const figurine = document.createElement('div');
            figurine.className = 'figurine';
            figurine.textContent = pieceTypes[piece.type].symbol;
            
            pieceDiv.appendChild(figurine);
            
            // Add health dots
            const healthDots = document.createElement('div');
            healthDots.className = 'health-dots';
            
            for (let i = 0; i < piece.maxHealth; i++) {
                const dot = document.createElement('div');
                dot.className = `health-dot ${i < piece.health ? 'healthy' : 'damaged'}`;
                healthDots.appendChild(dot);
            }
            
            pieceDiv.appendChild(healthDots);
            
            // Add drag functionality for battle phase
            if (gameState.gamePhase === 'battle' && piece.player === myPlayerNumber) {
                pieceDiv.draggable = true;
                pieceDiv.addEventListener('dragstart', (e) => {
                    const cell = e.target.closest('.cell');
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        fromRow: parseInt(cell.dataset.row),
                        fromCol: parseInt(cell.dataset.col)
                    }));
                    e.target.classList.add('dragging');
                });
                
                pieceDiv.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            }
            
            return pieceDiv;
        }

        function cellClick(row, col) {
            if (!myPlayerNumber || gameState.currentPlayer !== myPlayerNumber) {
                return;
            }

            if (gameState.gamePhase === 'battle') {
                if (!selectedCell) {
                    // Select a piece
                    const piece = gameState.board[row][col];
                    if (piece && piece.player === myPlayerNumber) {
                        selectedCell = { row, col };
                        renderBoard(); // Re-render to show selection
                        addMessage(`Selected ${piece.type} at ${row},${col}`, 'info');
                    }
                } else {
                    // Handle move or attack
                    const selectedPiece = gameState.board[selectedCell.row][selectedCell.col];
                    const targetPiece = gameState.board[row][col];

                    if (selectedCell.row === row && selectedCell.col === col) {
                        // Deselect
                        selectedCell = null;
                        renderBoard();
                        addMessage('Piece deselected', 'info');
                        return;
                    }

                    if (!targetPiece && canMove(selectedPiece, selectedCell.row, selectedCell.col, row, col)) {
                        // Move piece
                        if (!gameState.hasAttacked && !gameState.hasMoved) {
                            movePiece(selectedCell.row, selectedCell.col, row, col);
                            gameState.hasMoved = true;
                            addMessage('Move completed!', 'success');
                        } else {
                            addMessage('Invalid move timing!', 'error');
                        }
                    } else if (targetPiece && targetPiece.player !== selectedPiece.player) {
                        // Attack piece (simplified for demo)
                        if (!gameState.hasAttacked) {
                            attackPiece(selectedCell.row, selectedCell.col, row, col);
                            gameState.hasAttacked = true;
                            addMessage('Attack completed!', 'success');
                        } else {
                            addMessage('You can only attack once per turn!', 'error');
                        }
                    }

                    selectedCell = null;
                    renderBoard();
                }
            }
        }

        function canMove(piece, fromRow, fromCol, toRow, toCol) {
            // Check bounds
            if (toRow < 0 || toRow >= 7 || toCol < 0 || toCol >= 7) {
                return false;
            }

            // Simplified movement rules for demo
            const distance = Math.abs(fromRow - toRow) + Math.abs(fromCol - toCol);
            
            // Cavalry and Horse Archer movement (2 spaces)
            if (piece.type === 'Cavalry' || piece.type === 'Horse Archer') {
                const rowDiff = Math.abs(fromRow - toRow);
                const colDiff = Math.abs(fromCol - toCol);
                return (rowDiff <= 2 && colDiff === 0) || (rowDiff === 0 && colDiff <= 2);
            }

            // Standard movement
            return distance === 1;
        }

        function movePiece(fromRow, fromCol, toRow, toCol) {
            const piece = gameState.board[fromRow][fromCol];
            gameState.board[toRow][toCol] = piece;
            gameState.board[fromRow][fromCol] = null;
        }

        function attackPiece(attackerRow, attackerCol, targetRow, targetCol) {
            const target = gameState.board[targetRow][targetCol];
            if (!target) return;

            target.health -= 1;
            
            if (target.health <= 0) {
                gameState.board[targetRow][targetCol] = null;
                addMessage(`${target.type} destroyed!`, 'success');
                
                if (target.type === 'General') {
                    gameState.gameEnded = true;
                    gameState.winner = gameState.currentPlayer;
                    addMessage(`Player ${gameState.currentPlayer} wins! Enemy General defeated!`, 'victory');
                }
            }
        }

        function endTurn() {
            if (gameState.currentPlayer !== myPlayerNumber) {
                return;
            }

            // Handle placement phase turn ending
            if (gameState.gamePhase === 'placement') {
                const requiredPieces = gameState.placementTurn === 1 ? 4 : 
                    Object.values(myPlayerNumber === 1 ? gameState.player1Pieces : gameState.player2Pieces).reduce((a,b) => a+b, 0);
                
                if (gameState.piecesPlacedThisTurn !== requiredPieces) {
                    addMessage(`You must place exactly ${requiredPieces} pieces before ending your turn!`, 'error');
                    return;
                }
            }

            // Reset turn state
            gameState.selectedPiece = null;
            selectedCell = null;
            gameState.selectedPieceType = null;
            gameState.hasMoved = false;
            gameState.hasAttacked = false;

            // Handle phase transitions
            if (gameState.gamePhase === 'placement') {
                gameState.piecesPlacedThisTurn = 0;
                if (gameState.currentPlayer === 1) {
                    gameState.currentPlayer = 2;
                } else {
                    gameState.currentPlayer = 1;
                    gameState.placementTurn++;
                    if (gameState.placementTurn > 2) {
                        gameState.gamePhase = 'battle';
                        addMessage('Battle Phase begins!', 'info');
                    }
                }
            } else {
                gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
            }

            addMessage(`Turn ended. Now ${gameState.playerNames[gameState.currentPlayer]}'s turn.`, 'info');
            updateGameDisplay();
        }

        function addMessage(message, type = 'info') {
            const messageLog = document.getElementById('messageLog');
            const entry = document.createElement('div');
            entry.className = `message-entry ${type}`;
            entry.textContent = message;
            messageLog.appendChild(entry);
            messageLog.scrollTop = messageLog.scrollHeight;

            // Keep only last 20 messages
            while (messageLog.children.length > 20) {
                messageLog.removeChild(messageLog.firstChild);
            }
        }
    </script>
</body>
</html>
