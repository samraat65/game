<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ancient Empires</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding: 20px 0;
        }
        
        /* Nation Selection Styles */
        .nation-selection {
            background: white;
            padding: 2px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 800px;
        }
        
        .nation-selection h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .nation-selection .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        
        .selection-section {
            margin-bottom: 40px;
        }
        
        .selection-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .nation-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
            justify-items: center;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .nation-card {
            border: 3px solid #bdc3c7;
            border-radius: 10px;
            padding: 3px;
            width: 200px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ecf0f1;
        }
        
        .nation-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .nation-card.selected {
            border-color: #e74c3c;
            background: #ffe5e5;
            box-shadow: 0 5px 15px rgba(231,76,60,0.3);
        }
        
        .nation-card.player1-selected {
            border-color: #2196F3;
            background: #e3f2fd;
            box-shadow: 0 5px 15px rgba(33,150,243,0.3);
        }
        
        .nation-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .nation-description {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .nation-units {
            font-size: 0.8em;
            color: #34495e;
            background: rgba(255,255,255,0.7);
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .nation-special {
            font-size: 0.85em;
            color: #e74c3c;
            font-weight: bold;
            background: rgba(231,76,60,0.1);
            padding: 8px;
            border-radius: 5px;
        }
        
        .start-game-btn {
            padding: 15px 40px;
            font-size: 1.3em;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 30px;
            transition: background-color 0.3s ease;
        }
        
        .start-game-btn:hover {
            background-color: #229954;
        }
        
        .start-game-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .selection-status {
            margin-top: 20px;
            font-size: 1.1em;
            color: #2c3e50;
        }
        
        /* Game Container Styles (hidden initially) */
        .game-container {
            display: none;
            flex-direction: column;
            background: white;
            padding: 20px 2px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            align-items: center;
        }
        
        .main-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .board-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .bottom-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 490px;
            margin-top: 0;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(7, 70px);
            grid-template-rows: repeat(7, 70px);
            gap: 2px;
            margin: 3px auto 0;
            border: 2px solid #333;
            background-color: #8B4513;
            padding: 10px;
        }
        
        .cell {
            width: 70px;
            height: 70px;
            background-color: #DEB887;
            border: 1px solid #8B4513;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            font-size: 10px;
            font-weight: bold;
        }
        
        .cell.middle-row {
            background-color: #B8860B;
        }
        
        .cell.highlighted {
            background-color: #90EE90;
        }
        
        .cell.selected {
            background-color: #FFD700;
        }
        
        .cell.attack-range {
            background-color: #FFB6C1;
        }
        
        .piece {
            width: 60px;
            height: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }
        
        .figurine {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            border-radius: 50%;
            border: 2px solid;
            position: relative;
        }
        
        .player1 .figurine {
            background: linear-gradient(145deg, #4A90E2, #357EC7);
            border-color: #2E5C8A;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        
        .player2 .figurine {
            background: linear-gradient(145deg, #E74C3C, #C0392B);
            border-color: #A93226;
            color: #FFFFFF;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3), inset 0 1px 2px rgba(255,255,255,0.3);
        }
        
        .general-figurine {
            border-radius: 8px;
            font-size: 24px;
        }
        
        .cavalry-figurine {
            border-radius: 60% 40% 60% 40%;
        }
        
        .heavy-infantry-figurine {
            border-radius: 15%;
            font-size: 24px;
        }
        
        .light-infantry-figurine {
            border-radius: 25%;
            font-size: 26px;
        }
        
        .archer-figurine {
            border-radius: 30% 70% 30% 70%;
            font-size: 24px;
        }
        
        .health-dots {
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }
        
        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid #333;
        }
        
        .health-dot.healthy {
            background-color: #44ff44;
        }
        
        .health-dot.damaged {
            background-color: #333333;
        }
        
        .ammo-counter {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .replenished-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            background-color: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .phase-info {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            text-align: center;
        }
        
        .placement-counter {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
            text-align: center;
        }
        
        .turn-actions {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
            text-align: center;
        }
        
        .phase-requirement {
            font-size: 12px;
            color: #ff6600;
            margin-bottom: 3px;
            font-weight: bold;
            text-align: center;
        }
        
        .piece-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 3px 0;
            flex-wrap: wrap;
        }
        
        .piece-button {
            padding: 3px;
            border: 2px solid #333;
            background-color: #f9f9f9;
            cursor: pointer;
            border-radius: 5px;
            font-size: 12px;
            user-select: none;
        }
        
        .piece-button:hover {
            background-color: #e9e9e9;
        }
        
        .piece-button.selected {
            background-color: #4CAF50;
            color: white;
            border-color: #45a049;
        }
        
        .piece-button.disabled {
            background-color: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        
        .end-turn-btn {
            padding: 8px 16px;
            font-size: 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 140px;
            height: 34px;
        }
        
        .end-turn-btn:hover {
            background-color: #45a049;
        }
        
        .end-turn-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .player-box {
            border: 3px solid #333;
            padding: 5px;
            border-radius: 10px;
            position: relative;
            width: 140px;
            height: 34px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .player-box.player1 {
            background: linear-gradient(145deg, #E3F2FD, #BBDEFB);
            border-color: #E3F2FD;
        }
        
        .player-box.player2 {
            background: linear-gradient(145deg, #FFEBEE, #FFCDD2);
            border-color: #FFEBEE;
        }
        
        .player-box.active {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            border-color: #000000;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(0, 0, 0, 0.6); }
            to { box-shadow: 0 0 30px rgba(0, 0, 0, 0.9); }
        }
        
        .player-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 2px;
            line-height: 1;
        }
        
        .player-box.player1 .player-title {
            color: #1976D2;
        }
        
        .player-box.player2 .player-title {
            color: #D32F2F;
        }
        
        .nation-name-display {
            font-size: 10px;
            color: #666;
            font-style: italic;
            line-height: 1;
        }

        /* Attack Animation Styles */
        .attack-flash {
            animation: flashRed 0.3s ease-out;
        }

        @keyframes flashRed {
            0% { background-color: inherit; }
            50% { background-color: rgba(255, 0, 0, 0.7); }
            100% { background-color: inherit; }
        }

        /* Combat Log Styles */
        .combat-log {
            background: rgba(255,255,255,0.9);
            border: 2px solid #333;
            border-radius: 8px;
            padding: 10px;
            margin: 3px 0;
            height: 80px;
            overflow-y: auto;
            font-size: 12px;
            text-align: left;
        }

        .combat-log-entry {
            margin-bottom: 3px;
            padding: 2px 0;
        }

        /* Rules Section Styles */
        .rules-section {
            margin: 3px 0;
            text-align: center;
        }

        .rules-toggle {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .rules-toggle:hover {
            background-color: #2980b9;
        }

        .rules-content {
            display: none;
            background: rgba(255,255,255,0.9);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 0 auto;
            max-width: 450px;
            text-align: left;
            font-size: 13px;
            line-height: 1.4;
        }

        .rules-content.expanded {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Nation Selection Screen -->
    <div class="nation-selection" id="nationSelection">
        <h1>Ancient Empires</h1>
        <p class="subtitle">Choose your nations and begin the conquest</p>
        
        <div class="selection-section">
            <div class="selection-title">Player 1 (Blue) Nation</div>
            <div class="nation-cards" id="player1Nations">
                <div class="nation-card" data-nation="english">
                    <div class="nation-name">English</div>
                    <div class="nation-description">Masters of the longbow</div>
                    <div class="nation-special">‚Ä¢ Archers +1 range<br>‚Ä¢ Archers don't consume ammunition on kill shots</div>
                </div>
                
                <div class="nation-card" data-nation="mongols">
                    <div class="nation-name">Mongols</div>
                    <div class="nation-description">Swift mounted archers</div>
                    <div class="nation-special">‚Ä¢ 2 x Horse Archers and no foot archers<br>‚Ä¢ HA get 2 arrows each but no charge bonus<br>‚Ä¢ Only 1 standard cavalry unit</div>
                </div>
                
                <div class="nation-card" data-nation="macedonians">
                    <div class="nation-name">Macedonians</div>
                    <div class="nation-description">Alexander and Bucephalus</div>
                    <div class="nation-special">‚Ä¢ General has cavalry abilities</div>
                </div>
                
                <div class="nation-card" data-nation="spartans">
                    <div class="nation-name">Spartans</div>
                    <div class="nation-description">Elite Spartan Hoplites</div>
                    <div class="nation-special">‚Ä¢ Heavy Infantry can move diagonally<br>‚Ä¢ Heavy Infantry attacks hit all adjacent enemies simultaneously<br>‚Ä¢ No archer unit</div>
                </div>
            </div>
        </div>
        
        <div class="selection-section">
            <div class="selection-title">Player 2 (Red) Nation</div>
            <div class="nation-cards" id="player2Nations">
                <div class="nation-card" data-nation="english">
                    <div class="nation-name">English</div>
                    <div class="nation-description">Masters of the longbow</div>
                    <div class="nation-special">‚Ä¢ Archers +1 range<br>‚Ä¢ Archers don't consume ammunition on kill shots</div>
                </div>
                
                <div class="nation-card" data-nation="mongols">
                    <div class="nation-name">Mongols</div>
                    <div class="nation-description">Swift mounted archers</div>
                    <div class="nation-special">‚Ä¢ 2 x Horse Archers and no foot archers<br>‚Ä¢ HA get 2 arrows each but no charge bonus<br>‚Ä¢ Only 1 standard cavalry unit</div>
                </div>
                
                <div class="nation-card" data-nation="macedonians">
                    <div class="nation-name">Macedonians</div>
                    <div class="nation-description">Alexander and Bucephalus</div>
                    <div class="nation-special">‚Ä¢ General has cavalry abilities</div>
                </div>
                
                <div class="nation-card" data-nation="spartans">
                    <div class="nation-name">Spartans</div>
                    <div class="nation-description">Elite Spartan Hoplites</div>
                    <div class="nation-special">‚Ä¢ Heavy Infantry can move diagonally<br>‚Ä¢ Heavy Infantry attacks hit all adjacent enemies simultaneously<br>‚Ä¢ No archer unit</div>
                </div>
            </div>
        </div>
        
        <div class="selection-status" id="selectionStatus">
            Select nations for both players to begin
        </div>
        
        <button class="start-game-btn" id="startGameBtn" onclick="startGame()" disabled>
            Start Game
        </button>
    </div>

    <!-- Game Container (initially hidden) -->
    <div class="game-container" id="gameContainer">
        <div class="main-section">
            <h1>Ancient Empires</h1>
            
            <div class="rules-section">
                <button class="rules-toggle" onclick="toggleRules()">Show/Hide Rules</button>
                <div class="rules-content" id="rulesContent">
                    <h3>Game Rules</h3>
                    <p><strong>Objective:</strong> Eliminate the enemy General to win the game.</p>
                    <p><strong>Deployment Phase:</strong> Place 4 pieces in turn 1, then remaining pieces in turn 2. Player 1 uses top 3 rows, Player 2 uses bottom 3 rows. Whoever places first has first turn.</p>
                    <p><strong>Movement:</strong> Most pieces move 1 space orthogonally. Cavalry and Horse Archers can move 1-2 spaces in straight lines.</p>
                    <p><strong>Combat:</strong> Attack adjacent enemies for 1 damage. Archers and Horse Archers can attack at range along straight lines. After moving 2 spaces and attacking front-on, cavalry deals 2 damage (charge bonus). Heavy Infantry are immune to charge.</p>
                    <p><strong>Ammunition:</strong> Archers start with 3 arrows, Horse Archers with 2. They both have a range of 4 squares. They can both deal melee damage.</p>
                    <p><strong>Replenishment:</strong> When a piece reaches the enemy's back row (row 0 for Player 2, row 6 for Player 1), they are fully healed and regain all ammunition. This can only happen once per piece. Replenishment occurs even if a unit has full health/ammo. Generals cannot replenish.</p>
                    <p><strong>Turn Structure:</strong> Each turn you may move any piece once (optional), then attack with any piece once (optional). You cannot move after attacking.</p>
                    <p><strong>Nation Powers:</strong> Each nation has unique abilities - check the nation descriptions.</p>
                </div>
            </div>
            
            <div class="phase-info" id="phaseInfo">Placement Phase - Turn 1/2</div>
            <div class="placement-counter" id="placementCounter">Pieces placed this turn: 0/4</div>
            <div class="turn-actions" id="turnActions"></div>
            <div class="phase-requirement" id="phaseRequirement"></div>
            
            <div class="combat-log" id="combatLog">
                <div class="combat-log-entry">Game started - select your nations and begin placement!</div>
            </div>
            
            <div class="piece-selector" id="pieceSelector"></div>
            
            <div class="board-container">
                <div class="board" id="board"></div>
                <div class="bottom-controls">
                    <div class="player-box player1" id="player1Box">
                        <div class="player-title">Player 1</div>
                        <div class="nation-name-display" id="player1Nation">English</div>
                    </div>
                    
                    <button class="end-turn-btn" id="endTurnBtn" onclick="endTurn()">End Turn</button>
                    
                    <div class="player-box player2" id="player2Box">
                        <div class="player-title">Player 2</div>
                        <div class="nation-name-display" id="player2Nation">English</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        /* 
        =============================================================================
        NATION SELECTION AND GAME SETUP
        =============================================================================
        */
        
        let selectedPlayer1Nation = null;
        let selectedPlayer2Nation = null;
        
        // Nation definitions with special abilities
        const nations = {
            english: {
                name: 'English',
                pieces: { 'General': 1, 'Cavalry': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 1 },
                abilities: {
                    archerRangeBonus: 1,
                    archerKillAmmoSave: true
                }
            },
            mongols: {
                name: 'Mongols',
                pieces: { 'General': 1, 'Cavalry': 1, 'Horse Archer': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 0 },
                abilities: {
                    horseArcherMobility: true,
                    horseArcherAmmo: 2
                }
            },
            macedonians: {
                name: 'Macedonians',
                pieces: { 'General': 1, 'Cavalry': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 1 },
                abilities: {
                    alexanderCavalryMovement: true
                }
            },
            spartans: {
                name: 'Spartans',
                pieces: { 'General': 1, 'Cavalry': 2, 'Heavy Infantry': 2, 'Light Infantry': 2, 'Archer': 0 },
                abilities: {
                    heavyInfantryDiagonalMove: true,
                    heavyInfantryCleave: true
                }
            }
        };
        
        // Nation selection event handlers
        document.querySelectorAll('#player1Nations .nation-card').forEach(card => {
            card.addEventListener('click', () => selectPlayer1Nation(card.dataset.nation));
        });
        
        document.querySelectorAll('#player2Nations .nation-card').forEach(card => {
            card.addEventListener('click', () => selectPlayer2Nation(card.dataset.nation));
        });
        
        function selectPlayer1Nation(nation) {
            selectedPlayer1Nation = nation;
            
            // Update visual selection
            document.querySelectorAll('#player1Nations .nation-card').forEach(card => {
                card.classList.remove('player1-selected');
            });
            document.querySelector(`#player1Nations [data-nation="${nation}"]`).classList.add('player1-selected');
            
            updateSelectionStatus();
        }
        
        function selectPlayer2Nation(nation) {
            selectedPlayer2Nation = nation;
            
            // Update visual selection
            document.querySelectorAll('#player2Nations .nation-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`#player2Nations [data-nation="${nation}"]`).classList.add('selected');
            
            updateSelectionStatus();
        }
        
        function updateSelectionStatus() {
            const statusElement = document.getElementById('selectionStatus');
            const startBtn = document.getElementById('startGameBtn');
            
            if (selectedPlayer1Nation && selectedPlayer2Nation) {
                const p1Name = nations[selectedPlayer1Nation].name;
                const p2Name = nations[selectedPlayer2Nation].name;
                statusElement.textContent = `Ready! ${p1Name} vs ${p2Name}`;
                startBtn.disabled = false;
            } else if (selectedPlayer1Nation) {
                statusElement.textContent = `Player 1: ${nations[selectedPlayer1Nation].name} - choose Player 2 nation`;
                startBtn.disabled = true;
            } else if (selectedPlayer2Nation) {
                statusElement.textContent = `Player 2: ${nations[selectedPlayer2Nation].name} - choose Player 1 nation`;
                startBtn.disabled = true;
            } else {
                statusElement.textContent = 'Select nations for both players to begin';
                startBtn.disabled = true;
            }
        }
        
        function startGame() {
            // Hide nation selection, show game
            document.getElementById('nationSelection').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            
            // Initialize game with selected nations
            initGameWithNations(selectedPlayer1Nation, selectedPlayer2Nation);
        }
        
        /* 
        =============================================================================
        GAME STATE VARIABLES
        =============================================================================
        */
        
        // Core game state
        let currentPlayer = 1;
        let gamePhase = 'placement';
        let placementTurn = 1;
        let selectedCell = null;
        let board = [];
        let piecesPlacedThisTurn = 0;
        let gameEnded = false;
        
        // Battle phase turn state
        let hasMoved = false;
        let hasAttacked = false;
        let movedPieceCoords = null;
        
        // Nation-specific game state
        let player1Nation = null;
        let player2Nation = null;
        let player1Pieces = {};
        let player2Pieces = {};
        
        // Click-to-place state
        let selectedPieceType = null;
        
        /* 
        =============================================================================
        COMBAT LOG FUNCTIONS
        =============================================================================
        */
        
        function addCombatLogEntry(message) {
            const combatLog = document.getElementById('combatLog');
            const entry = document.createElement('div');
            entry.className = 'combat-log-entry';
            entry.textContent = message;
            combatLog.appendChild(entry);
            combatLog.scrollTop = combatLog.scrollHeight;
            
            // Keep only last 20 entries
            while (combatLog.children.length > 20) {
                combatLog.removeChild(combatLog.firstChild);
            }
        }
        
        function toggleRules() {
            const rulesContent = document.getElementById('rulesContent');
            rulesContent.classList.toggle('expanded');
        }
        
        /* 
        =============================================================================
        PIECE DEFINITIONS
        =============================================================================
        */
        
        const pieceTypes = {
            'General': { symbol: 'üëë', health: 3 },
            'Cavalry': { symbol: 'üêé', health: 2 },
            'Horse Archer': { symbol: 'üêéüèπ', health: 2, ammo: 2 },
            'Heavy Infantry': { symbol: 'üõ°Ô∏è', health: 3 },
            'Light Infantry': { symbol: '‚öîÔ∏è', health: 2 },
            'Archer': { symbol: 'üèπ', health: 2, ammo: 3 }
        };
        
        /* 
        =============================================================================
        GAME INITIALIZATION WITH NATIONS
        =============================================================================
        */
        
        function initGameWithNations(p1Nation, p2Nation) {
            player1Nation = p1Nation;
            player2Nation = p2Nation;
            
            // Set up piece counts based on nations
            player1Pieces = {...nations[p1Nation].pieces};
            player2Pieces = {...nations[p2Nation].pieces};
            
            // Update nation display in player boxes
            document.getElementById('player1Nation').textContent = nations[p1Nation].name;
            document.getElementById('player2Nation').textContent = nations[p2Nation].name;
            
            // Initialize game
            createBoard();
            updateUI();
            updatePieceSelector();
        }
        
        /* 
        =============================================================================
        NATION-SPECIFIC PIECE CREATION
        =============================================================================
        */
        
        function createPieceData(pieceType, player, nation) {
            const pieceData = {
                type: pieceType,
                player: player,
                health: pieceTypes[pieceType].health,
                maxHealth: pieceTypes[pieceType].health,
                hasBeenReplenished: false,
                placedInTurn: placementTurn,
                nation: nation
            };
            
            // Add ammo for archers or horse archers
            if (pieceType === 'Archer') {
                pieceData.ammo = pieceTypes[pieceType].ammo;
            } else if (pieceType === 'Horse Archer') {
                pieceData.ammo = pieceTypes[pieceType].ammo;
            }
            
            return pieceData;
        }
        
        /* 
        =============================================================================
        NATION-SPECIFIC ABILITIES
        =============================================================================
        */
        
        function getArcherRange(piece) {
            const nation = nations[piece.nation];
            let baseRange = 4;
            if (nation.abilities.archerRangeBonus) {
                baseRange += nation.abilities.archerRangeBonus;
            }
            return baseRange;
        }
        
        function shouldConsumeAmmo(attacker, target, distance) {
            // English archers don't consume ammo on kills
            if (attacker.type === 'Archer' && attacker.nation === 'english') {
                const nation = nations[attacker.nation];
                if (nation.abilities.archerKillAmmoSave) {
                    // Check if this attack will kill the target
                    let damage = 1;
                    if (target.health <= damage) {
                        return false; // Don't consume ammo
                    }
                }
            }
            return distance > 1; // Normal ammo consumption for ranged attacks
        }
        
        function canRangedAttack(piece, fromRow, fromCol, toRow, toCol) {
            const distance = Math.abs(fromRow - toRow) + Math.abs(fromCol - toCol);
            
            // Archer ranged attacks
            if (piece.type === 'Archer' && piece.ammo > 0) {
                const range = getArcherRange(piece);
                if ((fromRow === toRow || fromCol === toCol) && distance <= range) {
                    return true;
                }
            }
            
            // Horse Archer ranged attacks
            if (piece.type === 'Horse Archer' && piece.ammo > 0) {
                if ((fromRow === toRow || fromCol === toCol) && distance <= 4) {
                    return true;
                }
            }
            
            return false;
        }
        
        /* 
        =============================================================================
        INITIALIZATION FUNCTIONS
        =============================================================================
        */
        
        function createBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            board = [];
            for (let row = 0; row < 7; row++) {
                board[row] = [];
                for (let col = 0; col < 7; col++) {
                    board[row][col] = null;
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    if (row === 3) cell.classList.add('middle-row');
                    cell.dataset.row = row;
                    cell.dataset.col = col;
                    cell.onclick = () => cellClick(row, col);
                    boardElement.appendChild(cell);
                }
            }
        }

        /* 
        =============================================================================
        UI UPDATE FUNCTIONS
        =============================================================================
        */
        
        function canPlaceInRow(player, row) { 
            return player === 1 ? row <= 2 : row >= 4; 
        }
        
        function getRemainingUnitsCount(player) {
            const pieces = player === 1 ? player1Pieces : player2Pieces;
            return Object.values(pieces).reduce((sum, count) => sum + count, 0);
        }
        
        function getRequiredPiecesThisTurn(player) {
            if (placementTurn === 1) {
                return 4; // Always 4 on first turn
            } else {
                // On turn 2, calculate how many pieces should be placed total
                const nation = player === 1 ? player1Nation : player2Nation;
                const totalPieces = Object.values(nations[nation].pieces).reduce((sum, count) => sum + count, 0);
                return totalPieces - 4; // Total minus the 4 placed in turn 1
            }
        }
        
        function updateUI() {
            const player1Box = document.getElementById('player1Box');
            const player2Box = document.getElementById('player2Box');
            
            player1Box.classList.toggle('active', currentPlayer === 1);
            player2Box.classList.toggle('active', currentPlayer === 2);
            
            if (gamePhase === 'placement') {
                const requiredPieces = getRequiredPiecesThisTurn(currentPlayer);
                
                document.getElementById('phaseInfo').textContent = `Placement Phase - Turn ${placementTurn}/2`;
                document.getElementById('placementCounter').textContent = `Pieces placed this turn: ${piecesPlacedThisTurn}/${requiredPieces}`;
                document.getElementById('placementCounter').style.display = 'block';
                document.getElementById('turnActions').style.display = 'none';
                document.getElementById('phaseRequirement').style.display = 'none';
                
                const endTurnBtn = document.getElementById('endTurnBtn');
                if (piecesPlacedThisTurn === requiredPieces) {
                    endTurnBtn.disabled = false;
                    endTurnBtn.textContent = 'End Turn';
                } else {
                    endTurnBtn.disabled = true;
                    endTurnBtn.textContent = `End Turn (${requiredPieces - piecesPlacedThisTurn} more needed)`;
                }
            } else {
                document.getElementById('phaseInfo').textContent = 'Battle Phase';
                document.getElementById('placementCounter').style.display = 'none';
                document.getElementById('turnActions').style.display = 'block';
                document.getElementById('turnActions').textContent = `Moved: ${hasMoved ? 'Yes' : 'No'} | Attacked: ${hasAttacked ? 'Yes' : 'No'}`;
                
                const phaseReq = document.getElementById('phaseRequirement');
                phaseReq.style.display = 'block';
                if (!hasMoved && !hasAttacked) {
                    phaseReq.textContent = 'You can move one piece first (optional) then attack';
                    phaseReq.style.color = '#0066cc';
                } else if (hasMoved && !hasAttacked) {
                    phaseReq.textContent = 'You can now attack or end turn (no more moves allowed)';
                    phaseReq.style.color = '#0066cc';
                } else if (hasAttacked) {
                    phaseReq.textContent = 'Turn complete - you can no longer move';
                    phaseReq.style.color = '#009900';
                }
                
                document.getElementById('endTurnBtn').disabled = false;
                document.getElementById('endTurnBtn').textContent = 'End Turn';
            }
            renderBoard();
        }
        
        function updatePieceSelector() {
            const selector = document.getElementById('pieceSelector');
            selector.innerHTML = '';
            if (gamePhase === 'placement') {
                const pieces = currentPlayer === 1 ? player1Pieces : player2Pieces;
                const nation = currentPlayer === 1 ? player1Nation : player2Nation;
                const originalPieces = nations[nation].pieces;
                
                Object.entries(pieces).forEach(([type, count]) => {
                    // Only show buttons for pieces that start with a count > 0
                    if (originalPieces[type] > 0) {
                        const button = document.createElement('div');
                        button.className = `piece-button ${count === 0 ? 'disabled' : ''}`;
                        if (selectedPieceType === type) {
                            button.classList.add('selected');
                        }
                        
                        // Just show text without symbol
                        button.textContent = `${type} (${count})`;
                        
                        if (count > 0) {
                            button.addEventListener('click', () => selectPieceType(type));
                        }
                        
                        selector.appendChild(button);
                    }
                });
            }
        }
        
        function selectPieceType(type) {
            const pieces = currentPlayer === 1 ? player1Pieces : player2Pieces;
            if (pieces[type] === 0) return;
            
            selectedPieceType = selectedPieceType === type ? null : type;
            clearHighlights();
            updatePieceSelector();
            renderBoard();
        }
        
        /* 
        =============================================================================
        BATTLE PHASE FUNCTIONS
        =============================================================================
        */
        
        function cellClick(row, col) {
            if (gamePhase === 'placement') {
                placementPhaseClick(row, col);
            } else {
                battlePhaseClick(row, col);
            }
        }
        
        function placementPhaseClick(row, col) {
            const piece = board[row][col];
            
            // If we have a piece type selected for placing
            if (selectedPieceType) {
                if (canPlacePiece(row, col)) {
                    const pieces = currentPlayer === 1 ? player1Pieces : player2Pieces;
                    const nation = currentPlayer === 1 ? player1Nation : player2Nation;
                    
                    const pieceData = createPieceData(selectedPieceType, currentPlayer, nation);
                    
                    board[row][col] = pieceData;
                    pieces[selectedPieceType]--;
                    piecesPlacedThisTurn++;
                    
                    selectedPieceType = null; // Deselect after placing
                    updateUI();
                    updatePieceSelector();
                }
                return;
            }
            
            // If clicking on a piece that belongs to the current player, unplace it
            if (piece && piece.player === currentPlayer && !isPieceLocked(row, col)) {
                const pieces = currentPlayer === 1 ? player1Pieces : player2Pieces;
                
                // Return piece to selector
                pieces[piece.type]++;
                piecesPlacedThisTurn--;
                board[row][col] = null;
                
                updateUI();
                updatePieceSelector();
            }
        }
        
        function canPlacePiece(row, col) {
            if (board[row][col]) return false;
            if (!canPlaceInRow(currentPlayer, row)) return false;
            
            const requiredPieces = getRequiredPiecesThisTurn(currentPlayer);
            if (piecesPlacedThisTurn >= requiredPieces) return false;
            
            const pieces = currentPlayer === 1 ? player1Pieces : player2Pieces;
            if (pieces[selectedPieceType] === 0) return false;
            
            return true;
        }
        
        function isPieceLocked(row, col) {
            const piece = board[row][col];
            if (!piece) return false;
            return piece.placedInTurn && piece.placedInTurn < placementTurn;
        }
        
        function battlePhaseClick(row, col) {
            const piece = board[row][col];
            
            if (!selectedCell) {
                if (piece && piece.player === currentPlayer) {
                    selectedCell = {row, col};
                    highlightValidActions(row, col);
                    renderBoard();
                }
            } else {
                if (selectedCell.row === row && selectedCell.col === col) {
                    selectedCell = null;
                    clearHighlights();
                    renderBoard();
                    return;
                }
                
                const selectedPiece = board[selectedCell.row][selectedCell.col];
                const canMoveHere = canMove(selectedPiece, selectedCell.row, selectedCell.col, row, col);
                const canAttackHere = canAttack(selectedPiece, selectedCell.row, selectedCell.col, row, col);
                
                if (!piece && canMoveHere) {
                    if (!hasAttacked && !hasMoved) {
                        movePiece(selectedCell.row, selectedCell.col, row, col);
                        hasMoved = true;
                        movedPieceCoords = {row, col};
                    }
                } else if (piece && piece.player !== currentPlayer && canAttackHere) {
                    if (!hasAttacked) {
                        attackPiece(selectedCell.row, selectedCell.col, row, col);
                        hasAttacked = true;
                    }
                }
                
                selectedCell = null;
                clearHighlights();
                updateUI();
            }
        }